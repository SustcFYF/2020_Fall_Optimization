function varargout = mtsp_ga(xy,dmat,nSalesmen,minTour,popSize,numIter,showProg,showResult)

% Process Inputs and Initialize Defaults
nargs = 8;
for k = nargin:nargs-1
    switch k
        case 0
            xy = [  25.800000 88.300000;
 25.800000 89.300000;
 25.800000 90.300000;
 25.800000 91.300000;
 26.800000 86.300000;
 26.800000 87.300000;
 26.800000 88.300000;
 26.800000 89.300000;
 26.800000 90.300000;
 26.800000 91.300000;
 26.800000 92.300000;
 26.800000 93.300000;
 27.800000 86.300000;
 27.800000 87.300000;
 27.800000 88.300000;
 27.800000 89.300000;
 27.800000 90.300000;
 27.800000 91.300000;
 27.800000 92.300000;
 27.800000 93.300000;
 28.800000 85.300000;
 28.800000 86.300000;
 28.800000 87.300000;
 28.800000 88.300000;
 28.800000 89.300000;
 28.800000 90.300000;
 28.800000 91.300000;
 28.800000 92.300000;
 28.800000 93.300000;
 28.800000 94.300000;
 29.800000 85.300000;
 29.800000 86.300000;
 29.800000 87.300000;
 29.800000 88.300000;
 29.800000 89.300000;
 29.800000 90.300000;
 29.800000 91.300000;
 29.800000 92.300000;
 29.800000 93.300000;
 29.800000 94.300000;
 30.800000 85.300000;
 30.800000 86.300000;
 30.800000 87.300000;
 30.800000 88.300000;
 30.800000 89.300000;
 30.800000 90.300000;
 30.800000 91.300000;
 30.800000 92.300000;
 30.800000 93.300000;
 30.800000 94.300000;
 31.800000 85.300000;
 31.800000 86.300000;
 31.800000 87.300000;
 31.800000 88.300000;
 31.800000 89.300000;
 31.800000 90.300000;
 31.800000 91.300000;
 31.800000 92.300000;
 31.800000 93.300000;
 31.800000 94.300000;
 32.800000 86.300000;
 32.800000 87.300000;
 32.800000 88.300000;
 32.800000 89.300000;
 32.800000 90.300000;
 32.800000 91.300000;
 32.800000 92.300000;
 32.800000 93.300000;
 33.800000 86.300000;
 33.800000 87.300000;
 33.800000 88.300000;
 33.800000 89.300000;
 33.800000 90.300000;
 33.800000 91.300000;
 33.800000 92.300000;
 33.800000 93.300000;
 34.800000 88.300000;
 34.800000 89.300000;
 34.800000 90.300000;
 34.800000 91.300000;
 61.500000 83.200000;
 61.500000 84.200000;
 61.500000 85.200000;
 61.500000 86.200000;
 62.500000 81.200000;
 62.500000 82.200000;
 62.500000 83.200000;
 62.500000 84.200000;
 62.500000 85.200000;
 62.500000 86.200000;
 62.500000 87.200000;
 62.500000 88.200000;
 63.500000 81.200000;
 63.500000 82.200000;
 63.500000 83.200000;
 63.500000 84.200000;
 63.500000 85.200000;
 63.500000 86.200000;
 63.500000 87.200000;
 63.500000 88.200000;
 64.500000 80.200000;
 64.500000 81.200000;
 64.500000 82.200000;
 64.500000 83.200000;
 64.500000 84.200000;
 64.500000 85.200000;
 64.500000 86.200000;
 64.500000 87.200000;
 64.500000 88.200000;
 64.500000 89.200000;
 65.500000 80.200000;
 65.500000 81.200000;
 65.500000 82.200000;
 65.500000 83.200000;
 65.500000 84.200000;
 65.500000 85.200000;
 65.500000 86.200000;
 65.500000 87.200000;
 65.500000 88.200000;
 65.500000 89.200000;
 66.500000 80.200000;
 66.500000 81.200000;
 66.500000 82.200000;
 66.500000 83.200000;
 66.500000 84.200000;
 66.500000 85.200000;
 66.500000 86.200000;
 66.500000 87.200000;
 66.500000 88.200000;
 66.500000 89.200000;
 67.500000 80.200000;
 67.500000 81.200000;
 67.500000 82.200000;
 67.500000 83.200000;
 67.500000 84.200000;
 67.500000 85.200000;
 67.500000 86.200000;
 67.500000 87.200000;
 67.500000 88.200000;
 67.500000 89.200000;
 68.500000 81.200000;
 68.500000 82.200000;
 68.500000 83.200000;
 68.500000 84.200000;
 68.500000 85.200000;
 68.500000 86.200000;
 68.500000 87.200000;
 68.500000 88.200000;
 69.500000 81.200000;
 69.500000 82.200000;
 69.500000 83.200000;
 69.500000 84.200000;
 69.500000 85.200000;
 69.500000 86.200000;
 69.500000 87.200000;
 69.500000 88.200000;
 70.500000 83.200000;
 70.500000 84.200000;
 70.500000 85.200000;
 70.500000 86.200000;
 93.900000 75.200000;
 93.900000 76.200000;
 93.900000 77.200000;
 93.900000 78.200000;
 94.900000 73.200000;
 94.900000 74.200000;
 94.900000 75.200000;
 94.900000 76.200000;
 94.900000 77.200000;
 94.900000 78.200000;
 94.900000 79.200000;
 94.900000 80.200000;
 95.900000 73.200000;
 95.900000 74.200000;
 95.900000 75.200000;
 95.900000 76.200000;
 95.900000 77.200000;
 95.900000 78.200000;
 95.900000 79.200000;
 95.900000 80.200000;
 96.900000 72.200000;
 96.900000 73.200000;
 96.900000 74.200000;
 96.900000 75.200000;
 96.900000 76.200000;
 96.900000 77.200000;
 96.900000 78.200000;
 96.900000 79.200000;
 96.900000 80.200000;
 96.900000 81.200000;
 97.900000 72.200000;
 97.900000 73.200000;
 97.900000 74.200000;
 97.900000 75.200000;
 97.900000 76.200000;
 97.900000 77.200000;
 97.900000 78.200000;
 97.900000 79.200000;
 97.900000 80.200000;
 97.900000 81.200000;
 98.900000 72.200000;
 98.900000 73.200000;
 98.900000 74.200000;
 98.900000 75.200000;
 98.900000 76.200000;
 98.900000 77.200000;
 98.900000 78.200000;
 98.900000 79.200000;
 98.900000 80.200000;
 98.900000 81.200000;
 99.900000 72.200000;
 99.900000 73.200000;
 99.900000 74.200000;
 99.900000 75.200000;
 99.900000 76.200000;
 99.900000 77.200000;
 99.900000 78.200000;
 99.900000 79.200000;
 99.900000 80.200000;
 99.900000 81.200000;
 100.900000 73.200000;
 100.900000 74.200000;
 100.900000 75.200000;
 100.900000 76.200000;
 100.900000 77.200000;
 100.900000 78.200000;
 100.900000 79.200000;
 100.900000 80.200000;
 101.900000 73.200000;
 101.900000 74.200000;
 101.900000 75.200000;
 101.900000 76.200000;
 101.900000 77.200000;
 101.900000 78.200000;
 101.900000 79.200000;
 101.900000 80.200000;
 102.900000 75.200000;
 102.900000 76.200000;
 102.900000 77.200000;
 102.900000 78.200000;
 69.200000 59.500000;
 69.200000 60.500000;
 69.200000 61.500000;
 69.200000 62.500000;
 70.200000 57.500000;
 70.200000 58.500000;
 70.200000 59.500000;
 70.200000 60.500000;
 70.200000 61.500000;
 70.200000 62.500000;
 70.200000 63.500000;
 70.200000 64.500000;
 71.200000 57.500000;
 71.200000 58.500000;
 71.200000 59.500000;
 71.200000 60.500000;
 71.200000 61.500000;
 71.200000 62.500000;
 71.200000 63.500000;
 71.200000 64.500000;
 72.200000 56.500000;
 72.200000 57.500000;
 72.200000 58.500000;
 72.200000 59.500000;
 72.200000 60.500000;
 72.200000 61.500000;
 72.200000 62.500000;
 72.200000 63.500000;
 72.200000 64.500000;
 72.200000 65.500000;
 73.200000 56.500000;
 73.200000 57.500000;
 73.200000 58.500000;
 73.200000 59.500000;
 73.200000 60.500000;
 73.200000 61.500000;
 73.200000 62.500000;
 73.200000 63.500000;
 73.200000 64.500000;
 73.200000 65.500000;
 74.200000 56.500000;
 74.200000 57.500000;
 74.200000 58.500000;
 74.200000 59.500000;
 74.200000 60.500000;
 74.200000 61.500000;
 74.200000 62.500000;
 74.200000 63.500000;
 74.200000 64.500000;
 74.200000 65.500000;
 75.200000 56.500000;
 75.200000 57.500000;
 75.200000 58.500000;
 75.200000 59.500000;
 75.200000 60.500000;
 75.200000 61.500000;
 75.200000 62.500000;
 75.200000 63.500000;
 75.200000 64.500000;
 75.200000 65.500000;
 76.200000 57.500000;
 76.200000 58.500000;
 76.200000 59.500000;
 76.200000 60.500000;
 76.200000 61.500000;
 76.200000 62.500000;
 76.200000 63.500000;
 76.200000 64.500000;
 77.200000 57.500000;
 77.200000 58.500000;
 77.200000 59.500000;
 77.200000 60.500000;
 77.200000 61.500000;
 77.200000 62.500000;
 77.200000 63.500000;
 77.200000 64.500000;
 78.200000 59.500000;
 78.200000 60.500000;
 78.200000 61.500000;
 78.200000 62.500000;
 53.400000 46.100000;
 53.400000 47.100000;
 53.400000 48.100000;
 53.400000 49.100000;
 54.400000 44.100000;
 54.400000 45.100000;
 54.400000 46.100000;
 54.400000 47.100000;
 54.400000 48.100000;
 54.400000 49.100000;
 54.400000 50.100000;
 54.400000 51.100000;
 55.400000 44.100000;
 55.400000 45.100000;
 55.400000 46.100000;
 55.400000 47.100000;
 55.400000 48.100000;
 55.400000 49.100000;
 55.400000 50.100000;
 55.400000 51.100000;
 56.400000 43.100000;
 56.400000 44.100000;
 56.400000 45.100000;
 56.400000 46.100000;
 56.400000 47.100000;
 56.400000 48.100000;
 56.400000 49.100000;
 56.400000 50.100000;
 56.400000 51.100000;
 56.400000 52.100000;
 57.400000 43.100000;
 57.400000 44.100000;
 57.400000 45.100000;
 57.400000 46.100000;
 57.400000 47.100000;
 57.400000 48.100000;
 57.400000 49.100000;
 57.400000 50.100000;
 57.400000 51.100000;
 57.400000 52.100000;
 58.400000 43.100000;
 58.400000 44.100000;
 58.400000 45.100000;
 58.400000 46.100000;
 58.400000 47.100000;
 58.400000 48.100000;
 58.400000 49.100000;
 58.400000 50.100000;
 58.400000 51.100000;
 58.400000 52.100000;
 59.400000 43.100000;
 59.400000 44.100000;
 59.400000 45.100000;
 59.400000 46.100000;
 59.400000 47.100000;
 59.400000 48.100000;
 59.400000 49.100000;
 59.400000 50.100000;
 59.400000 51.100000;
 59.400000 52.100000;
 60.400000 44.100000;
 60.400000 45.100000;
 60.400000 46.100000;
 60.400000 47.100000;
 60.400000 48.100000;
 60.400000 49.100000;
 60.400000 50.100000;
 60.400000 51.100000;
 61.400000 44.100000;
 61.400000 45.100000;
 61.400000 46.100000;
 61.400000 47.100000;
 61.400000 48.100000;
 61.400000 49.100000;
 61.400000 50.100000;
 61.400000 51.100000;
 62.400000 46.100000;
 62.400000 47.100000;
 62.400000 48.100000;
 62.400000 49.100000;
 82.300000 20.500000;
 82.300000 21.500000;
 82.300000 22.500000;
 82.300000 23.500000;
 83.300000 18.500000;
 83.300000 19.500000;
 83.300000 20.500000;
 83.300000 21.500000;
 83.300000 22.500000;
 83.300000 23.500000;
 83.300000 24.500000;
 83.300000 25.500000;
 84.300000 18.500000;
 84.300000 19.500000;
 84.300000 20.500000;
 84.300000 21.500000;
 84.300000 22.500000;
 84.300000 23.500000;
 84.300000 24.500000;
 84.300000 25.500000;
 85.300000 17.500000;
 85.300000 18.500000;
 85.300000 19.500000;
 85.300000 20.500000;
 85.300000 21.500000;
 85.300000 22.500000;
 85.300000 23.500000;
 85.300000 24.500000;
 85.300000 25.500000;
 85.300000 26.500000;
 86.300000 17.500000;
 86.300000 18.500000;
 86.300000 19.500000;
 86.300000 20.500000;
 86.300000 21.500000;
 86.300000 22.500000;
 86.300000 23.500000;
 86.300000 24.500000;
 86.300000 25.500000;
 86.300000 26.500000;
 87.300000 17.500000;
 87.300000 18.500000;
 87.300000 19.500000;
 87.300000 20.500000;
 87.300000 21.500000;
 87.300000 22.500000;
 87.300000 23.500000;
 87.300000 24.500000;
 87.300000 25.500000;
 87.300000 26.500000;
 88.300000 17.500000;
 88.300000 18.500000;
 88.300000 19.500000;
 88.300000 20.500000;
 88.300000 21.500000;
 88.300000 22.500000;
 88.300000 23.500000;
 88.300000 24.500000;
 88.300000 25.500000;
 88.300000 26.500000;
 89.300000 18.500000;
 89.300000 19.500000;
 89.300000 20.500000;
 89.300000 21.500000;
 89.300000 22.500000;
 89.300000 23.500000;
 89.300000 24.500000;
 89.300000 25.500000;
 90.300000 18.500000;
 90.300000 19.500000;
 90.300000 20.500000;
 90.300000 21.500000;
 90.300000 22.500000;
 90.300000 23.500000;
 90.300000 24.500000;
 90.300000 25.500000;
 91.300000 20.500000;
 91.300000 21.500000;
 91.300000 22.500000;
 91.300000 23.500000;
 89.100000 47.300000;
 89.100000 48.300000;
 89.100000 49.300000;
 89.100000 50.300000;
 90.100000 45.300000;
 90.100000 46.300000;
 90.100000 47.300000;
 90.100000 48.300000;
 90.100000 49.300000;
 90.100000 50.300000;
 90.100000 51.300000;
 90.100000 52.300000;
 91.100000 45.300000;
 91.100000 46.300000;
 91.100000 47.300000;
 91.100000 48.300000;
 91.100000 49.300000;
 91.100000 50.300000;
 91.100000 51.300000;
 91.100000 52.300000;
 92.100000 44.300000;
 92.100000 45.300000;
 92.100000 46.300000;
 92.100000 47.300000;
 92.100000 48.300000;
 92.100000 49.300000;
 92.100000 50.300000;
 92.100000 51.300000;
 92.100000 52.300000;
 92.100000 53.300000;
 93.100000 44.300000;
 93.100000 45.300000;
 93.100000 46.300000;
 93.100000 47.300000;
 93.100000 48.300000;
 93.100000 49.300000;
 93.100000 50.300000;
 93.100000 51.300000;
 93.100000 52.300000;
 93.100000 53.300000;
 94.100000 44.300000;
 94.100000 45.300000;
 94.100000 46.300000;
 94.100000 47.300000;
 94.100000 48.300000;
 94.100000 49.300000;
 94.100000 50.300000;
 94.100000 51.300000;
 94.100000 52.300000;
 94.100000 53.300000;
 95.100000 44.300000;
 95.100000 45.300000;
 95.100000 46.300000;
 95.100000 47.300000;
 95.100000 48.300000;
 95.100000 49.300000;
 95.100000 50.300000;
 95.100000 51.300000;
 95.100000 52.300000;
 95.100000 53.300000;
 96.100000 45.300000;
 96.100000 46.300000;
 96.100000 47.300000;
 96.100000 48.300000;
 96.100000 49.300000;
 96.100000 50.300000;
 96.100000 51.300000;
 96.100000 52.300000;
 97.100000 45.300000;
 97.100000 46.300000;
 97.100000 47.300000;
 97.100000 48.300000;
 97.100000 49.300000;
 97.100000 50.300000;
 97.100000 51.300000;
 97.100000 52.300000;
 98.100000 47.300000;
 98.100000 48.300000;
 98.100000 49.300000;
 98.100000 50.300000;
];
        case 1
            N = size(xy,1);
            a = meshgrid(1:N);
            dmat = reshape(sqrt(sum((xy(a,:)-xy(a',:)).^2,2)),N,N);
        case 2
            nSalesmen = 2;
        case 3
            minTour = 2;
        case 4
            popSize = 80;
        case 5
            numIter = 1e4;
        case 6
            showProg = 1;
        case 7
            showResult = 1;
        otherwise
    end
end

% Verify Inputs
[N,dims] = size(xy);
[nr,nc] = size(dmat);
if N ~= nr || N ~= nc
    error('Invalid XY or DMAT inputs!')
end
n = N;

% Sanity Checks
nSalesmen = max(1,min(n,round(real(nSalesmen(1)))));
minTour = max(1,min(floor(n/nSalesmen),round(real(minTour(1)))));
popSize = max(8,8*ceil(popSize(1)/8));
numIter = max(1,round(real(numIter(1))));
showProg = logical(showProg(1));
showResult = logical(showResult(1));

% Initializations for Route Break Point Selection
nBreaks = nSalesmen-1;
dof = n - minTour*nSalesmen;          % degrees of freedom
addto = ones(1,dof+1);
for k = 2:nBreaks
    addto = cumsum(addto);
end
cumProb = cumsum(addto)/sum(addto);

% Initialize the Populations
popRoute = zeros(popSize,n);         % population of routes
popBreak = zeros(popSize,nBreaks);   % population of breaks
popRoute(1,:) = (1:n);
popBreak(1,:) = rand_breaks();
for k = 2:popSize
    popRoute(k,:) = randperm(n);
    popBreak(k,:) = rand_breaks();
end

% Select the Colors for the Plotted Routes
pclr = ~get(0,'DefaultAxesColor');
clr = [1 0 0; 0 0 1; 0.67 0 1; 0 1 0; 1 0.5 0];
if nSalesmen > 5
    clr = hsv(nSalesmen);
end

% Run the GA
globalMin = Inf;
totalDist = zeros(1,popSize);
distHistory = zeros(1,numIter);
tmpPopRoute = zeros(8,n);
tmpPopBreak = zeros(8,nBreaks);
newPopRoute = zeros(popSize,n);
newPopBreak = zeros(popSize,nBreaks);
if showProg
    pfig = figure('Name','MTSP_GA | Current Best Solution','Numbertitle','off');
end
for iter = 1:numIter
    % Evaluate Members of the Population
    for p = 1:popSize
        d = 0;
        pRoute = popRoute(p,:);
        pBreak = popBreak(p,:);
        rng = [[1 pBreak+1];[pBreak n]]';
        for s = 1:nSalesmen
            d = d + dmat(pRoute(rng(s,2)),pRoute(rng(s,1)));
            for k = rng(s,1):rng(s,2)-1
                d = d + dmat(pRoute(k),pRoute(k+1));
            end
        end
        totalDist(p) = d;
    end

    % Find the Best Route in the Population
    [minDist,index] = min(totalDist);
    distHistory(iter) = minDist;
    if minDist < globalMin
        globalMin = minDist;
        optRoute = popRoute(index,:);
        optBreak = popBreak(index,:);
        rng = [[1 optBreak+1];[optBreak n]]';
        if showProg
            % Plot the Best Route
            figure(pfig);
            for s = 1:nSalesmen
                rte = optRoute([rng(s,1):rng(s,2) rng(s,1)]);
                if dims > 2, plot3(xy(rte,1),xy(rte,2),xy(rte,3),'.-','Color',clr(s,:));
                else plot(xy(rte,1),xy(rte,2),'.-','Color',clr(s,:)); end
                title(sprintf('Total Distance = %1.4f, Iteration = %d',minDist,iter));
                hold on
            axis equal
            end
            hold off
        end
    end

    % Genetic Algorithm Operators
    randomOrder = randperm(popSize);
    for p = 8:8:popSize
        rtes = popRoute(randomOrder(p-7:p),:);
        brks = popBreak(randomOrder(p-7:p),:);
        dists = totalDist(randomOrder(p-7:p));
        [ignore,idx] = min(dists); %#ok
        bestOf8Route = rtes(idx,:);
        bestOf8Break = brks(idx,:);
        routeInsertionPoints = sort(ceil(n*rand(1,2)));
        I = routeInsertionPoints(1);
        J = routeInsertionPoints(2);
        for k = 1:8 % Generate New Solutions
            tmpPopRoute(k,:) = bestOf8Route;
            tmpPopBreak(k,:) = bestOf8Break;
            switch k
                case 2 % Flip
                    tmpPopRoute(k,I:J) = tmpPopRoute(k,J:-1:I);
                case 3 % Swap
                    tmpPopRoute(k,[I J]) = tmpPopRoute(k,[J I]);
                case 4 % Slide
                    tmpPopRoute(k,I:J) = tmpPopRoute(k,[I+1:J I]);
                case 5 % Modify Breaks
                    tmpPopBreak(k,:) = rand_breaks();
                case 6 % Flip, Modify Breaks
                    tmpPopRoute(k,I:J) = tmpPopRoute(k,J:-1:I);
                    tmpPopBreak(k,:) = rand_breaks();
                case 7 % Swap, Modify Breaks
                    tmpPopRoute(k,[I J]) = tmpPopRoute(k,[J I]);
                    tmpPopBreak(k,:) = rand_breaks();
                case 8 % Slide, Modify Breaks
                    tmpPopRoute(k,I:J) = tmpPopRoute(k,[I+1:J I]);
                    tmpPopBreak(k,:) = rand_breaks();
                otherwise % Do Nothing
            end
        end
        newPopRoute(p-7:p,:) = tmpPopRoute;
        newPopBreak(p-7:p,:) = tmpPopBreak;
    end
    popRoute = newPopRoute;
    popBreak = newPopBreak;
end

if showResult
% Plots
    figure('Name','MTSP_GA | Results','Numbertitle','off');
    subplot(2,2,1);
    if dims > 2, plot3(xy(:,1),xy(:,2),xy(:,3),'.','Color',pclr);
    else plot(xy(:,1),xy(:,2),'.','Color',pclr); end
    title('City Locations');
    subplot(2,2,2);
    imagesc(dmat(optRoute,optRoute));
    title('Distance Matrix');
    subplot(2,2,3);
    rng = [[1 optBreak+1];[optBreak n]]';
    for s = 1:nSalesmen
        rte = optRoute([rng(s,1):rng(s,2) rng(s,1)]);
        if dims > 2, plot3(xy(rte,1),xy(rte,2),xy(rte,3),'.-','Color',clr(s,:));
        else plot(xy(rte,1),xy(rte,2),'.-','Color',clr(s,:)); end
        title(sprintf('Total Distance = %1.4f',minDist));
        hold on;
    end
    subplot(2,2,4);
    plot(distHistory,'b','LineWidth',2);
    title('Best Solution History');
    set(gca,'XLim',[0 numIter+1],'YLim',[0 1.1*max([1 distHistory])]);
end

% Return Outputs
if nargout
    varargout{1} = optRoute;
    varargout{2} = optBreak;
    varargout{3} = minDist;
end

    % Generate Random Set of Break Points
    function breaks = rand_breaks()
        if minTour == 1 % No Constraints on Breaks
            tmpBreaks = randperm(n-1);
            breaks = sort(tmpBreaks(1:nBreaks));
        else % Force Breaks to be at Least the Minimum Tour Length
            nAdjust = find(rand < cumProb,1)-1;
            spaces = ceil(nBreaks*rand(1,nAdjust));
            adjust = zeros(1,nBreaks);
            for kk = 1:nBreaks
                adjust(kk) = sum(spaces == kk);
            end
            breaks = minTour*(1:nBreaks) + cumsum(adjust);
        end
    end
end